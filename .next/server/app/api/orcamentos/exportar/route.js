"use strict";(()=>{var e={};e.id=4525,e.ids=[4525],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{e.exports=require("punycode")},17171:(e,r,o)=>{o.r(r),o.d(r,{patchFetch:()=>g,routeModule:()=>m,serverHooks:()=>f,workAsyncStorage:()=>x,workUnitAsyncStorage:()=>v});var t={};o.r(t),o.d(t,{GET:()=>_});var a=o(96559),s=o(48088),i=o(37719),d=o(32190),n=o(63511),u=o(2507),p=o(96890),c=o(86481),l=o(41954);let _=(0,p.ru)(async e=>{try{let r=new URL(e.url).searchParams.get("pedido_id");if((0,c.fH)(`Iniciando exporta\xe7\xe3o de or\xe7amento para pedido: ${r}`),!r)return(0,c.vV)("ID do pedido n\xe3o fornecido na exporta\xe7\xe3o"),d.NextResponse.json({error:"ID do pedido n\xe3o fornecido. Use o par\xe2metro pedido_id."},{status:400});let o=e.headers.get("authorization").split(" ")[1],{data:{user:t},error:a}=await n.ND.auth.getUser(o);if(a||!t)return(0,c.vV)("Erro ao identificar usu\xe1rio na exporta\xe7\xe3o",a),d.NextResponse.json({error:"Erro ao identificar o usu\xe1rio"},{status:401});(0,c.fH)(`Usu\xe1rio identificado: ${t.id}`);let{data:s,error:i}=await u.E.from("pedidos").select(`
        id, 
        produto_id, 
        quantidade, 
        status, 
        observacoes, 
        user_id,
        tem_frete,
        valor_frete,
        margem_lucro_percentual,
        impostos_percentual
      `).eq("id",r).single();if(i||!s)return(0,c.vV)(`Erro ao buscar pedido ${r}`,i),d.NextResponse.json({error:"Pedido n\xe3o encontrado"},{status:404});if(s.user_id!==t.id)return(0,c.vV)(`Pedido ${r} n\xe3o pertence ao usu\xe1rio ${t.id}`),d.NextResponse.json({error:"Pedido n\xe3o pertence ao usu\xe1rio atual"},{status:403});let{data:p,error:_}=await u.E.from("produtos").select("id, nome, descricao, preco_unitario").eq("id",s.produto_id).single(),m={...s,produto:p||null};(0,c.fH)(`Pedido encontrado: ${m.id}, quantidade: ${m.quantidade}`);let x={id:p?.id||"N/A",nome:p?.nome||"N/A",descricao:p?.descricao||"N/A",preco_unitario:p?.preco_unitario||0};(0,c.fH)(`Produto extra\xeddo: ${x.nome}`);try{let e=await (0,l.f$)(r);(0,c.fH)(`Or\xe7amento completo gerado para o pedido ${r}`);let o=new Date,a=new Date;a.setDate(o.getDate()+30);let s=new Intl.DateTimeFormat("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric"}),i=e.detalhes_materiais?.map(e=>({nome:e.nome,quantidade:e.quantidade_necessaria,preco_unitario:e.preco_unitario,subtotal:e.subtotal}))||[],n=e.detalhes_processos?.map(e=>({nome:e.nome,quantidade:e.quantidade,preco_por_unidade:e.preco_por_unidade,subtotal:e.subtotal}))||[],u=e.detalhes_mao_de_obra?.map(e=>({tipo:e.tipo,horas:e.horas,preco_por_hora:e.preco_por_hora,subtotal:e.subtotal}))||[],p=e.detalhes_itens_extras?.map(e=>({nome:e.nome,descricao:e.descricao,valor:e.valor}))||[],_={informacoes_gerais:{codigo_orcamento:`ORC-${r}`,data_geracao:s.format(o),data_validade:s.format(a),valido_por_dias:30},cliente:{id:t.id,email:t.email,nome:t.user_metadata?.nome||t.email},produto:{id:x.id,nome:x.nome,descricao:x.descricao,quantidade:m.quantidade,preco_unitario:x.preco_unitario},pedido:{id:m.id,status:m.status,observacoes:m.observacoes||"",tem_frete:m.tem_frete,valor_frete:m.valor_frete,margem_lucro_percentual:m.margem_lucro_percentual,impostos_percentual:m.impostos_percentual},detalhamento:{materiais:i,processos:n,mao_de_obra:u,itens_extras:p},resumo:{custo_total_materiais:e.custo_total_materiais,custo_total_processos:e.custo_total_processos,custo_total_mao_de_obra:e.custo_total_mao_de_obra,custo_total_itens_extras:e.custo_total_itens_extras,valor_frete:e.valor_frete,subtotal:e.subtotal,margem_lucro_percentual:e.margem_lucro_percentual,valor_margem_lucro:e.valor_margem_lucro,total_com_margem:e.total_com_margem,impostos_percentual:e.impostos_percentual,valor_impostos:e.valor_impostos,custo_total:e.custo_total},observacoes:["Pre\xe7os sujeitos a altera\xe7\xe3o ap\xf3s a data de validade.","Or\xe7amento n\xe3o constitui compromisso de execu\xe7\xe3o.",`Margem de lucro aplicada: ${e.margem_lucro_percentual}%`,`Impostos aplicados: ${e.impostos_percentual}%`,e.valor_frete>0?`Frete inclu\xeddo: R$ ${e.valor_frete.toFixed(2)}`:"Frete n\xe3o aplicado"].filter(e=>"Frete n\xe3o aplicado"!==e)};return(0,c.fH)(`Or\xe7amento exportado com sucesso para o pedido ${r}`,{custo_total:_.resumo.custo_total,materiais:i.length,processos:n.length,mao_de_obra:u.length,itens_extras:p.length,valor_frete:e.valor_frete,margem_lucro:e.valor_margem_lucro,impostos:e.valor_impostos}),d.NextResponse.json({data:_})}catch(e){return(0,c.vV)(`Erro ao gerar or\xe7amento para o pedido ${r}`,e),d.NextResponse.json({error:"Erro ao gerar or\xe7amento detalhado"},{status:500})}}catch(e){return(0,c.vV)("Erro n\xe3o tratado ao exportar or\xe7amento",e),d.NextResponse.json({error:"Erro interno ao processar a requisi\xe7\xe3o"},{status:500})}}),m=new a.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/orcamentos/exportar/route",pathname:"/api/orcamentos/exportar",filename:"route",bundlePath:"app/api/orcamentos/exportar/route"},resolvedPagePath:"C:\\Aplicativos\\saas\\src\\app\\api\\orcamentos\\exportar\\route.ts",nextConfigOutput:"",userland:t}),{workAsyncStorage:x,workUnitAsyncStorage:v,serverHooks:f}=m;function g(){return(0,i.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:v})}},21820:e=>{e.exports=require("os")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{e.exports=require("zlib")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var r=require("../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[4447,580,4296,3683],()=>o(17171));module.exports=t})();