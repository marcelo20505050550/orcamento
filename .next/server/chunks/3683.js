exports.id=3683,exports.ids=[3683],exports.modules={2507:(e,o,r)=>{"use strict";r.d(o,{E:()=>a});let a=(0,r(86345).UU)("https://delvfbrkwsuudzunzdlk.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{persistSession:!1,autoRefreshToken:!1}})},41954:(e,o,r)=>{"use strict";r.d(o,{f$:()=>c});var a=r(2507),t=r(86481);async function s(e,o,r=0,i=[],d=new Map){try{if(r>20)return(0,t.vV)(`Limite de recurs\xe3o atingido ao calcular depend\xeancias para o produto ${e}`,{caminho:i,nivel:r}),d;if(i.includes(e))return(0,t.vV)(`Ciclo de depend\xeancia detectado para o produto ${e}`,{caminho:i,produtoId:e}),d;let n=[...i,e],{data:c,error:u}=await a.E.from("dependencias_produtos").select(`
        produto_filho_id,
        quantidade_necessaria,
        produto_filho:produto_filho_id (
          nome,
          e_materia_prima
        )
      `).eq("produto_pai_id",e);if(u)return(0,t.vV)(`Erro ao buscar depend\xeancias do produto ${e}`,u),d;if(c&&Array.isArray(c))for(let e of c){let a=e.produto_filho_id,t=e.quantidade_necessaria*o,i=e.produto_filho,c=!1;i&&"object"==typeof i&&(c=!!i.e_materia_prima);let u=d.get(a);u?d.set(a,{...u,quantidade_necessaria:u.quantidade_necessaria+t}):d.set(a,{produto_id:a,quantidade_necessaria:t,nivel:r+1,caminho:n}),c||await s(a,t,r+1,n,d)}return d}catch(o){throw(0,t.vV)(`Erro n\xe3o tratado ao calcular depend\xeancias recursivas para o produto ${e}`,o),o}}async function i(e,o){try{let r=await s(e,o),i=Array.from(r.keys());if(0===i.length)return[];let{data:d,error:n}=await a.E.from("produtos").select("id, nome, preco_unitario, quantidade_estoque, e_materia_prima").in("id",i).eq("e_materia_prima",!0);if(n)throw(0,t.vV)(`Erro ao buscar detalhes das mat\xe9rias-primas`,n),n;let c=[];if(d&&Array.isArray(d))for(let e of d){let o=r.get(e.id);o&&c.push({produto_id:e.id,nome:e.nome,quantidade_necessaria:o.quantidade_necessaria,preco_unitario:e.preco_unitario,subtotal:e.preco_unitario*o.quantidade_necessaria,disponivel_estoque:e.quantidade_estoque>=o.quantidade_necessaria})}return c.sort((e,o)=>e.nome.localeCompare(o.nome))}catch(o){throw(0,t.vV)(`Erro n\xe3o tratado ao calcular requisitos de mat\xe9rias-primas para o produto ${e}`,o),o}}async function d(e){try{let{data:o,error:r}=await a.E.from("processos_pedidos").select(`
        processo_id,
        quantidade,
        processo:processo_id (
          nome,
          preco_por_unidade,
          tempo_estimado_minutos
        )
      `).eq("pedido_id",e);if(r)throw(0,t.vV)(`Erro ao buscar processos do pedido ${e}`,r),r;let s=[];if(o&&Array.isArray(o))for(let e of o){let o=e.processo;if(o&&"object"==typeof o){let r=o.preco_por_unidade||0,a=e.quantidade||0,t=o.tempo_estimado_minutos||0;s.push({processo_id:e.processo_id,nome:o.nome||"Processo sem nome",quantidade:a,preco_por_unidade:r,tempo_estimado_minutos:t,subtotal:r*a})}}return s.sort((e,o)=>e.nome.localeCompare(o.nome))}catch(o){throw(0,t.vV)(`Erro n\xe3o tratado ao calcular custos de processos para o pedido ${e}`,o),o}}async function n(e){try{let{data:o,error:r}=await a.E.from("mao_de_obra_pedidos").select(`
        mao_de_obra_id,
        horas,
        mao_de_obra:mao_de_obra_id (
          tipo,
          preco_por_hora
        )
      `).eq("pedido_id",e);if(r)throw(0,t.vV)(`Erro ao buscar m\xe3o de obra do pedido ${e}`,r),r;let s=[];if(o&&Array.isArray(o))for(let e of o){let o=e.mao_de_obra;if(o&&"object"==typeof o){let r=o.preco_por_hora||0,a=e.horas||0;s.push({mao_de_obra_id:e.mao_de_obra_id,tipo:o.tipo||"Tipo sem nome",horas:a,preco_por_hora:r,subtotal:r*a})}}return s.sort((e,o)=>e.tipo.localeCompare(o.tipo))}catch(o){throw(0,t.vV)(`Erro n\xe3o tratado ao calcular custos de m\xe3o de obra para o pedido ${e}`,o),o}}async function c(e){try{let o,r,s,c,{data:u,error:p}=await a.E.from("pedidos").select(`
        id,
        produto_id,
        quantidade,
        tem_frete,
        valor_frete,
        margem_lucro_percentual,
        impostos_percentual,
        produto:produto_id (
          nome,
          preco_unitario
        )
      `).eq("id",e).single();if(p||!u)throw(0,t.vV)(`Erro ao buscar pedido ${e}`,p),Error(`Pedido ${e} n\xe3o encontrado`);let _=await d(e),l=await n(e),m=await i(u.produto_id,u.quantidade),f=[];try{let{data:o,error:r}=await a.E.from("itens_extras_pedidos").select("*").eq("pedido_id",e).order("created_at",{ascending:!1});r?((0,t.vV)(`Erro ao buscar itens extras do pedido ${e}`,r),f=[]):f=o||[]}catch(o){(0,t.vV)(`Erro cr\xedtico ao buscar itens extras do pedido ${e}`,o),f=[]}let h=m.reduce((e,o)=>e+o.subtotal,0),E=_.reduce((e,o)=>e+o.subtotal,0),v=l.reduce((e,o)=>e+o.subtotal,0),b=f.reduce((e,o)=>e+o.valor,0),y=u.tem_frete&&u.valor_frete||0,w=h+E+v+b+y,x=u.margem_lucro_percentual||0;x>0?r=(o=w/((100-x)/100))-w:(o=w,r=0);let g=u.impostos_percentual||0;return g>0?c=(s=o/((100-g)/100))-o:(s=o,c=0),{pedido_id:e,custo_total_materiais:h,custo_total_processos:E,custo_total_mao_de_obra:v,custo_total_itens_extras:b,valor_frete:y,subtotal:w,margem_lucro_percentual:x,valor_margem_lucro:r,total_com_margem:o,impostos_percentual:g,valor_impostos:c,custo_total:s,detalhes_materiais:m,detalhes_processos:_,detalhes_mao_de_obra:l,detalhes_itens_extras:f}}catch(o){throw(0,t.vV)(`Erro n\xe3o tratado ao gerar or\xe7amento completo para o pedido ${e}`,o),o}}},63511:(e,o,r)=>{"use strict";r.d(o,{ND:()=>i});var a=r(86345);let t="https://delvfbrkwsuudzunzdlk.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlbHZmYnJrd3N1dWR6dW56ZGxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NjMxMzIsImV4cCI6MjA2NDAzOTEzMn0.0eq-pFMGWuDHFmzyehrYSLKDP6HY2CBDMsU3ynZpR8g";if(!t||!s)throw Error("As vari\xe1veis de ambiente NEXT_PUBLIC_SUPABASE_URL e NEXT_PUBLIC_SUPABASE_ANON_KEY precisam estar configuradas");let i=(0,a.UU)(t,s,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0,storageKey:"orcamentos-auth-token"}})},78335:()=>{},86481:(e,o,r)=>{"use strict";r.d(o,{Ay:()=>f,fH:()=>l,vV:()=>m});var a=r(91728),t=r.n(a);let{format:s,transports:i}=t(),{combine:d,timestamp:n,printf:c,colorize:u}=s,p=c(({level:e,message:o,timestamp:r})=>`[${r}] ${e}: ${o}`),_=t().createLogger({level:"info",format:d(n({format:"YYYY-MM-DD HH:mm:ss"}),p),transports:[new i.Console({format:d(u(),n({format:"YYYY-MM-DD HH:mm:ss"}),p)}),new i.File({filename:"logs/error.log",level:"error"}),new i.File({filename:"logs/combined.log"})]}),l=(e,o)=>{_.info(o?`${e} ${JSON.stringify(o)}`:e)},m=(e,o)=>{o instanceof Error?_.error(`${e}: ${o.message}`,{stack:o.stack}):o?_.error(`${e}: ${JSON.stringify(o)}`):_.error(e)},f=_},96487:()=>{},96890:(e,o,r)=>{"use strict";r.d(o,{fS:()=>d,ru:()=>n});var a=r(32190),t=r(86345),s=r(86481);async function i(e){try{let o=(0,t.UU)("https://delvfbrkwsuudzunzdlk.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{persistSession:!1,autoRefreshToken:!1}}),r=e.headers.get("authorization");if(!r||!r.startsWith("Bearer "))return a.NextResponse.json({error:"Token de autentica\xe7\xe3o n\xe3o fornecido"},{status:401});let s=r.split(" ")[1],{data:i,error:d}=await o.auth.getUser(s);if(d||!i.user)return console.error("Erro de autentica\xe7\xe3o:",d),a.NextResponse.json({error:"Token de autentica\xe7\xe3o inv\xe1lido ou expirado"},{status:401});return null}catch(e){return(0,s.vV)("Erro no middleware de autentica\xe7\xe3o",e),a.NextResponse.json({error:"Erro ao processar autentica\xe7\xe3o"},{status:500})}}function d(e){return async(o,...r)=>{try{return await e(o,...r)}catch(e){return(0,s.vV)("Erro n\xe3o tratado na API",e),a.NextResponse.json({error:"Ocorreu um erro ao processar a requisi\xe7\xe3o",message:e instanceof Error?e.message:"Erro desconhecido"},{status:500})}}}function n(e){return async(o,r)=>{let a=await i(o);return a||d(e)(o,r)}}}};